!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.iccivmjs=t():e.iccivmjs=t()}(self,(function(){return(()=>{"use strict";var t={757:(t,n)=>{function o(e){return new RTCSessionDescription(e)}function r(e){this.wsSocket,this.keepaliveTimerId,this.bNeedReconnect=!1,this.bDisConnected=!1,this._debug=!0,void 0!==e.consolelog&&"false"===e.consolelog&&(this._debug=!1),this._conf=e,this._videoId=e.videoid,this._pbconf=e.pbconf,this._token=e.token,this._nReconnectCnt=1,void 0===this._videoId?(this._videodom=e.videodom,!0===this._debug&&console.log("[RTC] use dom directly",e.token)):(this._videodom=document.getElementById(this._videoId),!0===this._debug&&console.log("[RTC] use videoid",e.token)),this.video=this._videodom,this.pc=null,this.pcOptions={optional:[{DtlsSrtpKeyAgreement:!0}]},this.mediaConstraints={mandatory:{offerToReceiveAudio:!0,offerToReceiveVideo:!0}},this.pcConfig={iceServers:[]},this.earlyCandidates=[],this._strPosterUri,null!=this._pbconf&&"false"==this._pbconf.showposter||(this._strPosterUri=this._conf.protocol+"//"+this._conf.host+this._conf.rootpath+"api/v1/GetImage?token="+this._token+"&session="+this._conf.session,!0===this._debug&&console.log("[WS] connect src",e.token),this._videodom.setAttribute("poster",this._strPosterUri))}function i(e){this.wsSocket,this.keepaliveTimerId,this.bNeedReconnect=!1,this.bDisConnected=!1,this._debug=!0,void 0!==e.consolelog&&"false"===e.consolelog&&(this._debug=!1),this._conf=e,this._videoId=e.localvideoid,this._user=e.user,this._nReconnectCnt=1,void 0===this._videoId?(this._localvideodom=e.localvideodom,!0===this._debug&&console.log("[PUSH] use dom directly",e.user)):(this._localvideodom=document.getElementById(this._videoId),!0===this._debug&&console.log("[PUSH] use videoid",e.user)),this.video=this._localvideodom,this.pc=null,this.pcOptions={optional:[{DtlsSrtpKeyAgreement:!0}]},this.mediaConstraints={mandatory:{offerToReceiveAudio:!1,offerToReceiveVideo:!1}},this.pcConfig={iceServers:[]},this.earlyCandidates=[]}Object.defineProperty(n,"__esModule",{value:!0}),console.log("[Icc]","Iccplayer r1.1.0829"),r.prototype.ReconnectFunction=function(){if(!0===this.bNeedReconnect){!0===this._debug&&console.log("[RTC] Reconnect...");var e=this._strPosterUri+"&update="+this._nReconnectCnt;this._videodom.setAttribute("poster",e),!0===this._debug&&console.log("[RTC] Reconnect image",e),this._nReconnectCnt++,this.setupWebSocket(this._token),this.bNeedReconnect=!1}},r.prototype.H5SWebSocketClient=function(e){var t;!0===this._debug&&console.log("[RTC] H5SWebSocketClient");try{"http:"==this._conf.protocol&&(t="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this._conf.host+e):new WebSocket("ws://"+this._conf.host+e)),"https:"==this._conf.protocol&&(!0===this._debug&&console.log(this._conf.host),t="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this._conf.host+e):new WebSocket("wss://"+this._conf.host+e)),!0===this._debug&&console.log(this._conf.host)}catch(e){return void alert("error")}return t},r.prototype.keepaliveTimer=function(){try{this.wsSocket.send(JSON.stringify({type:"keepalive"}))}catch(e){!0===this._debug&&console.log(e)}},r.prototype.onIceCandidate=function(e){if(e.candidate){var t;!0===this._debug&&console.log("[RTC] onIceCandidate currentice",e.candidate),t=e.candidate,!0===this._debug&&console.log("[RTC] onIceCandidate currentice",JSON.stringify(t));var n=JSON.parse(JSON.stringify(t));n.type="remoteice",!0===this._debug&&console.log("[RTC] onIceCandidate currentice new",JSON.stringify(n)),this.wsSocket.send(JSON.stringify(n))}else!0===this._debug&&console.log("End of candidates.")},r.prototype.onTrack=function(e){var t;!0===this._debug&&console.log("[RTC] Remote track added:"+JSON.stringify(e)),t=e.streams?e.streams[0]:e.stream;var n=this._videodom;n.srcObject=t,n.play()},r.prototype.createPeerConnection=function(){!0===this._debug&&console.log("[RTC] createPeerConnection  config: "+JSON.stringify(this.pcConfig)+" option:"+JSON.stringify(this.pcOptions));var e=new RTCPeerConnection(this.pcConfig,this.pcOptions),t=this;return e.onicecandidate=function(e){t.onIceCandidate.call(t,e)},void 0!==e.ontrack?e.ontrack=function(e){t.onTrack.call(t,e)}:e.onaddstream=function(e){t.onTrack.call(t,e)},e.oniceconnectionstatechange=function(n){!0===t._debug&&console.log("[RTC] oniceconnectionstatechange  state: "+e.iceConnectionState)},!0===this._debug&&console.log("[RTC] Created RTCPeerConnnection with config: "+JSON.stringify(this.pcConfig)+"option:"+JSON.stringify(this.pcOptions)),e},r.prototype.ProcessRTCOffer=function(e){!0===this._debug&&console.log("[RTC] ProcessRTCOffer",e);try{this.pc=this.createPeerConnection(),this.earlyCandidates.length=0;var t=this;!0===this._debug&&console.log("[RTC] createRTCSessionDescription "),this.pc.setRemoteDescription(o(e)),this.pc.createAnswer(this.mediaConstraints).then((function(e){!0===t._debug&&console.log("[RTC] Create answer:"+JSON.stringify(e)),t.pc.setLocalDescription(e,(function(){!0===t._debug&&console.log("[RTC] ProcessRTCOffer createAnswer",e),t.wsSocket.send(JSON.stringify(e))}),(function(){}))}),(function(e){alert("[RTC] Create awnser error:"+JSON.stringify(e))}))}catch(e){this.disconnect(),alert("[RTC] connect error: "+e)}},r.prototype.ProcessRemoteIce=function(e){!0===this._debug&&console.log("[RTC] ProcessRemoteIce",e);try{var t=new RTCIceCandidate({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate});!0===this._debug&&console.log("[RTC] ProcessRemoteIce",t),!0===this._debug&&console.log("[RTC] Adding ICE candidate :"+JSON.stringify(t)),this.pc.addIceCandidate(t,(function(){}),(function(e){console.log("[RTC] addIceCandidate error:"+JSON.stringify(e))}))}catch(e){alert("connect ProcessRemoteIce error: "+e)}},r.prototype.onWebSocketData=function(e){e.data,ArrayBuffer,e.data,!0===this._debug&&console.log("[RTC] RTC received ",e.data);var t=JSON.parse(e.data);return!0===this._debug&&console.log("[RTC] Get Message type ",t.type),"offer"===t.type?(!0===this._debug&&console.log("[RTC] Process Message type ",t.type),void this.ProcessRTCOffer(t)):"iceserver"===t.type?(!0===this._debug&&console.log("[RTC] Process Message type ",t.type),this.pcConfig.iceServers=t.iceServers,this.pcConfig.iceTransportPolicy=t.iceTransportPolicy,void(!0===this._debug&&console.log("[RTC] Iceserver:",this.pcConfig))):"remoteice"===t.type?(!0===this._debug&&console.log("[RTC] Process Message type ",t.type),void this.ProcessRemoteIce(t)):void(null!=this._pbconf&&null!=this._pbconf.callback&&this._pbconf.callback(e.data,this._pbconf.userdata))},r.prototype.setupWebSocket=function(e){this.video.autoplay=!0;var t="api/v1/h5srtcapi",n="main";if(void 0===this._conf.streamprofile||(n=this._conf.streamprofile),void 0===this._pbconf)t=this._conf.rootpath+t+"?token="+e+"&profile="+n+"&session="+this._conf.session;else{var o="false",r="fake";void 0===this._pbconf.serverpb||(o=this._pbconf.serverpb),void 0===this._pbconf.filename||(r=this._pbconf.filename),t=this._conf.rootpath+t+"?token="+e+"&playback=true&profile="+n+"&serverpb="+o+"&begintime="+encodeURIComponent(this._pbconf.begintime)+"&endtime="+encodeURIComponent(this._pbconf.endtime)+"&filename="+r+"&session="+this._conf.session}!0===this._debug&&console.log(t),this.wsSocket=this.H5SWebSocketClient(t),!0===this._debug&&console.log("[RTC] setupWebSocket",this.wsSocket),this.wsSocket.binaryType="arraybuffer",this.wsSocket.h5=this,this.wsSocket.onmessage=this.onWebSocketData.bind(this),this.wsSocket.onopen=function(){!0===this.h5._debug&&console.log("[RTC] wsSocket.onopen",this.h5);this.h5.wsSocket.send(JSON.stringify({type:"open"})),this.h5.keepaliveTimerId=setInterval(this.h5.keepaliveTimer.bind(this.h5),1e3),null!=this.h5._pbconf&&"true"===this.h5._pbconf.autoplay&&this.h5.start()},this.wsSocket.onclose=function(){!0===this._debug&&console.log("[RTC] wsSocket.onclose",this.h5),!0===this.h5.bDisConnected?!0===this.h5._debug&&console.log("[RTC] wsSocket.onclose disconnect"):this.h5.bNeedReconnect=!0,this.h5.CleanupWebSocket(this.h5)}},r.prototype.CleanupWebSocket=function(e){!0===e._debug&&console.log("[RTC] CleanupWebSocket",e),clearInterval(e.keepaliveTimerId)},r.prototype.connect=function(){this.setupWebSocket(this._token),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)},r.prototype.disconnect=function(){if(!0===this._debug&&console.log("[RTC] disconnect",this),this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this._videodom&&(this._videodom.src=""),this.pc){try{this.pc.close()}catch(e){!0===this._debug&&console.log("[RTC] close peer connection failed:"+e)}this.pc=null}!0===this._debug&&console.log("[RTC] disconnect",this)},r.prototype.start=function(){try{this.wsSocket.send(JSON.stringify({cmd:"H5_START"}))}catch(e){!0===this._debug&&console.log(e)}},r.prototype.pause=function(){try{this.wsSocket.send(JSON.stringify({cmd:"H5_PAUSE"}))}catch(e){!0===this._debug&&console.log(e)}},r.prototype.resume=function(){try{this.wsSocket.send(JSON.stringify({cmd:"H5_RESUME"}))}catch(e){!0===this._debug&&console.log(e)}},r.prototype.seek=function(e){try{var t={cmd:"H5_SEEK"};t.nSeekTime=e,this.wsSocket.send(JSON.stringify(t))}catch(e){!0===this._debug&&console.log(e)}},r.prototype.speed=function(e){try{var t={cmd:"H5_SPEED"};t.nSpeed=e,this.wsSocket.send(JSON.stringify(t))}catch(e){!0===this._debug&&console.log(e)}},i.prototype.ReconnectFunction=function(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[PUSH] Reconnect..."),this.setupWebSocket(this._user),this.bNeedReconnect=!1)},i.prototype.H5SWebSocketClient=function(e){var t;!0===this._debug&&console.log("[PUSH] H5SWebSocketClient");try{"http:"==this._conf.protocol&&(t="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this._conf.host+e):new WebSocket("ws://"+this._conf.host+e)),"https:"==this._conf.protocol&&(!0===this._debug&&console.log(this._conf.host),t="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this._conf.host+e):new WebSocket("wss://"+this._conf.host+e)),!0===this._debug&&console.log(this._conf.host)}catch(e){return void alert("error")}return t},i.prototype.keepaliveTimer=function(){try{this.wsSocket.send(JSON.stringify({type:"keepalive"}))}catch(e){!0===this._debug&&console.log(e)}},i.prototype.onIceCandidate=function(e){if(e.candidate){var t;!0===this._debug&&console.log("[PUSH] onIceCandidate currentice",e.candidate),t=e.candidate,!0===this._debug&&console.log("[PUSH] onIceCandidate currentice",JSON.stringify(t));var n=JSON.parse(JSON.stringify(t));n.type="remoteice",!0===this._debug&&console.log("[PUSH] onIceCandidate currentice new",JSON.stringify(n)),this.wsSocket.send(JSON.stringify(n))}else!0===this._debug&&console.log("End of candidates.")},i.prototype.onTrack=function(e){!0===this._debug&&console.log("[PUSH] Remote track added:"+JSON.stringify(e)),e.streams?e.streams[0]:e.stream},i.prototype.createPeerConnection=function(){!0===this._debug&&console.log("[PUSH] createPeerConnection  config: "+JSON.stringify(this.pcConfig)+" option:"+JSON.stringify(this.pcOptions));var e=new RTCPeerConnection(this.pcConfig,this.pcOptions),t=this;return e.onicecandidate=function(e){t.onIceCandidate.call(t,e)},void 0!==e.ontrack?e.ontrack=function(e){t.onTrack.call(t,e)}:e.onaddstream=function(e){t.onTrack.call(t,e)},e.oniceconnectionstatechange=function(n){!0===t._debug&&console.log("[PUSH] oniceconnectionstatechange  state: "+e.iceConnectionState)},!0===this._debug&&console.log("[PUSH] Created RTCPeerConnnection with config: "+JSON.stringify(this.pcConfig)+"option:"+JSON.stringify(this.pcOptions)),e},i.prototype.SetBitrate=function(e,t){if(("chrome"===adapter.browserDetails.browser||"safari"===adapter.browserDetails.browser||"firefox"===adapter.browserDetails.browser&&adapter.browserDetails.version>=64)&&"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype)for(var n=e.getSenders(),o=0;o!==n.length;++o){var r=n[o];if("video"==r.track.kind){var i=r.getParameters();i.encodings||(i.encodings=[{}]),i.encodings[0].maxBitrate=1e3*t,r.setParameters(i).then((function(){})).catch((function(e){return console.error(e)}))}}},i.prototype.CreateOffer=function(){var e=this;!0===this._debug&&console.log("[PUSH] CreateOffer");try{this.pc=this.createPeerConnection(),this.earlyCandidates.length=0;var t=this,n=this._streamlocal.getVideoTracks(),o=this._streamlocal.getAudioTracks();n.length>0&&console.log("[PUSH] Using video device:",n[0].label),o.length>0&&console.log("[PUSH] Using audio device:",o[0].label),this._streamlocal.getTracks().forEach((function(t){return e.pc.addTrack(t,e._streamlocal)}));var r=window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype;try{if(r){var i="video/H264";"VP9"==this._codec?i="video/VP9":"H264"==this._codec&&(i="video/H264");for(var s=window.RTCRtpSender.getCapabilities("video").codecs,a=[],c=0;c!==s.length;++c){var d=s[c];[i].includes(d.mimeType)&&a.push(d)}!0===t._debug&&console.log("[PUSH] Select codec:",a),this.pc.getTransceivers().find((function(t){return t.sender&&t.sender.track===e._streamlocal.getVideoTracks()[0]})).setCodecPreferences(a)}}catch(e){}return void this.pc.createOffer(this.mediaConstraints).then((function(e){!0===t._debug&&console.log("[PUSH] Create offer:"+JSON.stringify(e)),t.pc.setLocalDescription(e,(function(){var n=e;t.wsSocket.send(JSON.stringify(n))}),(function(){}))}),(function(e){alert("[PUSH ]Create offer error:"+JSON.stringify(e))}))}catch(e){this.disconnect(),alert("connect error: "+e)}},i.prototype.ProcessAnswer=function(e){!0===this._debug&&console.log("[PUSH] ProcessAnswer",e);try{this.pc.setRemoteDescription(o(e))}catch(e){this.disconnect(),alert("connect error: "+e)}this.SetBitrate(this.pc,this._bitrate)},i.prototype.ProcessRemoteIce=function(e){!0===this._debug&&console.log("[PUSH] ProcessRemoteIce",e);try{var t=new RTCIceCandidate({sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate});!0===this._debug&&console.log("[PUSH] ProcessRemoteIce",t),!0===this._debug&&console.log("[PUSH] Adding ICE candidate :"+JSON.stringify(t)),this.pc.addIceCandidate(t,(function(){}),(function(e){console.log("[PUSH] addIceCandidate error:"+JSON.stringify(e)),console.log(e)}))}catch(e){alert("connect ProcessRemoteIce error: "+e)}},i.prototype.onWebSocketData=function(e){e.data,ArrayBuffer,e.data,!0===this._debug&&console.log("[PUSH] RTC received ",e.data);var t=JSON.parse(e.data);return!0===this._debug&&console.log("[PUSH] Get Message type ",t.type),"iceserver"===t.type?(!0===this._debug&&console.log("[PUSH] Process Message type ",t.type),this.pcConfig.iceServers=t.iceServers,!0===this._debug&&console.log("[PUSH] Iceserver:",this.pcConfig),void this.CreateOffer()):"answer"===t.type?(!0===this._debug&&console.log("[PUSH] Process Message type ",t.type),void this.ProcessAnswer(t)):"remoteice"===t.type?(!0===this._debug&&console.log("[PUSH] Process Message type ",t.type),void this.ProcessRemoteIce(t)):void(null!=this._conf.callback&&this._conf.callback(e.data,this._conf.userdata))},i.prototype.setupWebSocket=function(e){this.video.autoplay=!0;var t="api/v1/h5srtcpushapi";t=this._conf.rootpath+t+"?token="+e+"&conftoken="+this._conftoken+"&type="+this._conf.type+"&session="+this._conf.session,!0===this._debug&&console.log(t),this.wsSocket=this.H5SWebSocketClient(t),!0===this._debug&&console.log("[PUSH] setupWebSocket",this.wsSocket),this.wsSocket.binaryType="arraybuffer",this.wsSocket.h5=this,this.wsSocket.onmessage=this.onWebSocketData.bind(this),this.wsSocket.onopen=function(){!0===this.h5._debug&&console.log("[PUSH] wsSocket.onopen",this.h5);this.h5.wsSocket.send(JSON.stringify({type:"open"})),this.h5.keepaliveTimerId=setInterval(this.h5.keepaliveTimer.bind(this.h5),1e3),null!=this.h5._pbconf&&"true"===this.h5._pbconf.autoplay&&this.h5.start()},this.wsSocket.onclose=function(){!0===this._debug&&console.log("[PUSH] wsSocket.onclose",this.h5),!0===this.h5.bDisConnected?!0===this.h5._debug&&console.log("[PUSH] wsSocket.onclose disconnect"):this.h5.bNeedReconnect=!0,this.h5.CleanupWebSocket(this.h5)}},i.prototype.CleanupWebSocket=function(e){!0===e._debug&&console.log("[PUSH] CleanupWebSocket",e),clearInterval(e.keepaliveTimerId)},i.prototype.connect=function(e,t){this._param=t,this._conftoken=e,this._videoin=t.videoin,this._codec=t.codec,this._bitrate=t.bitrate,this._resolution=t.resolution,this._audioin=t.audioin,!0===this._debug&&console.log("[PUSH] videoin:",t.videoin,"codec:",t.codec,"bitrate:",t.bitrate,"resolution:",t.resolution,"audioin:",t.audioin);var n,o,r=1280,i=720;"QVGA"==t.resolution?(r=320,i=240):"VGA"==t.resolution?(r=640,i=480):"D1"==t.resolution?(r=720,i=576):"720P"==t.resolution?(r=1280,i=720):"1080P"==t.resolution?(r=1920,i=1080):"4K"==t.resolution?(r=4096,i=2160):"8K"==t.resolution&&(r=7680,i=4320);var s="",a=!1;void 0!==this._param.facingmode&&(s=this._param.facingmode,!0===this._debug&&console.log("[PUSH] facing mode:",s),a=!0),n="true"==this._param.audio,o="true"==this._param.video&&(a?{facingMode:{exact:s},width:{exact:r},height:{exact:i}}:{deviceId:{exact:t.videoin},width:{exact:r},height:{exact:i}}),console.log(t.videoin);try{console.log(t.videoin);var c={audio:n,video:o};try{var d=this;0==this._param.desktopshare?navigator.mediaDevices.getUserMedia(c).then((function(e){d._localvideodom.srcObject=e,d._streamlocal=e,d.setupWebSocket(d._user)})).catch((function(e){var t="[PUSH] getUserMedia failed: "+e.name+" "+e.message;alert(t)})):navigator.mediaDevices.getDisplayMedia({video:!0}).then((function(e){d._localvideodom.srcObject=e,d._streamlocal=e,d.setupWebSocket(d._user)})).catch((function(e){alert("[PUSH] getUserMedia failed:",e.name+": "+e.message)}))}catch(e){var u="[PUSH] getUserMedia failed: "+err.name+" "+err.message;return void alert(u)}}catch(e){return void(!0===this._debug&&console.log(e))}},i.prototype.send=function(e,t){var n={type:"message"};n.user=this._user,n.token=e,n.msg=t,this.wsSocket.send(JSON.stringify(n))},i.prototype.disconnect=function(){if(!0===this._debug&&console.log("[PUSH] disconnect",this),this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this._localvideodom&&(this._localvideodom.src=""),this.pc){try{this.pc.close()}catch(e){!0===this._debug&&console.log("[PUSH] close peer connection failed:"+e)}this.pc=null}!0===this._debug&&console.log("[PUSH] disconnect",this)},n.IccPlayerRTC=r,n.IccRTCPush=i,n.IccRTCGetCapability=function(t,n,o){var r={},i=[],s=[],a=[],c=[];if(null==n);else{var d=n,u=n.resolution,l=1280,f=720;"QVGA"==u?(l=320,f=240):"VGA"==u?(l=640,f=480):"D1"==u?(l=720,f=576):"720P"==u?(l=1280,f=720):"1080P"==u?(l=1920,f=1080):"4K"==u?(l=4096,f=2160):"8K"==u&&(l=7680,f=4320);var p,v,g="",h=!1;void 0!==d.facingmode&&(g=d.facingmode,h=!0);var m=n.localvideoid,b=document.getElementById(m);console.log(b,m,document.getElementById(m))," true"==d.audio?(console.log(d.audio),p={deviceId:{exact:n.audioin}}):p=!1,v="true"==d.video&&(h?{facingMode:{exact:g},width:{exact:l},height:{exact:f}}:{deviceId:{exact:n.videoin},width:{exact:l},height:{exact:f},codec:{exact:n.codec},bitrate:{exact:n.bitrate}}),console.log(n.bitrate);var y={audio:p,video:v};navigator.mediaDevices.getUserMedia(y).then((function(e){e&&null!=b&&(console.log(e),console.log(b),b.srcObject=e,b.play())})).catch((function(e){var t="[PUSH] getUserMedia failed: "+e.name+" "+e.message;alert(t)}))}if(null!=t){if(window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype){for(var S=window.RTCRtpSender.getCapabilities("video").codecs,w=!1,k=!1,_=0;_!==S.length;++_){var T=S[_];["video/red","video/ulpfec","video/rtx"].includes(T.mimeType)||(["video/VP9"].includes(T.mimeType)?w=!0:["video/H264"].includes(T.mimeType)&&(k=!0))}1==w&&i.push("VP9"),1==k&&i.push("H264")}else i.push("Default");navigator.mediaDevices.enumerateDevices().then((function(e){for(var n=0;n!==e.length;++n){var o=e[n],d={};d.id=o.deviceId,d.name=o.label,"audioinput"===o.kind?s.push(d):"audiooutput"===o.kind?a.push(d):"videoinput"===o.kind&&c.push(d)}r.videocodec=i,r.videoin=c,r.audioin=s,r.audioout=a,t(r),console.log(c)})).catch((function(n){null!=t&&alert("[PUSH] enumerateDevices failed",e)}))}}},805:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});var o,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.room=e,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"isLive",value:function(){return this.plugin&&"completed"!==this.plugin.webrtcStuff.pc.iceConnectionState&&"connected"!==this.plugin.webrtcStuff.pc.iceConnectionState}},{key:"isAudioMuted",value:function(){return this.plugin.isAudioMuted()}},{key:"muteAudio",value:function(){var e=this;return new Promise((function(t,n){e.plugin.send({message:{request:"configure",muted:!0},success:t,error:n})}))}},{key:"unmuteAudio",value:function(){var e=this;return new Promise((function(t,n){e.plugin.send({message:{request:"configure",muted:!1},success:t,error:n})}))}},{key:"changeBandwidth",value:function(e){var t=this;return new Promise((function(n,o){t.plugin.send({message:{request:"configure",bitrate:e},success:n,error:o})}))}},{key:"connect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise((function(n,o){e.room.janus.attach({plugin:"janus.plugin.audiobridge",opaqueId:""+e.room.user.id,success:function(o){e.plugin=o;var r={request:"join",room:e.room.room_id,id:e.room.user.id,display:e.room.user.name,pin:e.pin,muted:!0,join_opts:t};e.plugin.send({message:r,success:n})},error:o,consentDialog:function(e){},mediaState:function(t,n){e.emit("mediaState",t,n)},webrtcState:function(t){e.emit("webrtcState",t)},onmessage:function(t,n){console.log("Got message",t),e.emit("onmessage",t,n);var r=t.audiobridge;r&&("joined"===r?e.plugin.createOffer({media:{video:!1,audio:!0,audioSend:!0,captureDesktopAudio:{echoCancellation:!0}},success:function(n){console.debug("Got SDP!"),console.debug(n),e.plugin.send({message:{request:"configure",muted:!0},jsep:n,success:function(){e.emit("joined",t,n)}})},error:o}):"destroyed"===r?e.emit(r,t,n):"event"===r&&(void 0!==t.error&&null!==t.error?e.emit("handle_error",t):void 0!==t.publishers&&null!==t.publishers?e.emit("publishers",t,n):void 0!==t.leaving&&null!==t.leaving?e.emit("leaving",t,n):void 0!==t.unpublished&&null!==t.unpublished&&e.emit("unpublished",t,n))),null!=n&&(console.debug("Handling SDP as well..."),console.debug(n),e.plugin.handleRemoteJsep({jsep:n}))},onlocalstream:function(t){console.log(" ::: Got a local stream :::"),e.emit("onlocalstream",t)},onremotestream:function(t){console.log(" ::: Got remote stream :::"),e.remote_stream=t,e.emit("onremotestream",t)},oncleanup:function(){e.emit("oncleanup")}})}))}},{key:"publish",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise((function(n,o){var r={audioRecv:!1,videoRecv:!1,audioSend:!0,videoSend:!1,video:!1};for(var i in t)r[i]=t[i];e.plugin.createOffer({media:r,simulcast:!1,success:function(t){console.debug(t),e.plugin.send({message:{request:"configure",muted:!1},jsep:t,success:n,error:o})},error:o})}))}}]),t}(((o=n(39))&&o.__esModule?o:{default:o}).default);t.default=i},39:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var n,o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r="object"===("undefined"==typeof Reflect?"undefined":o(Reflect))?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function d(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===e?"undefined":o(e)))}function u(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function l(e,t,n,o){var r,i,s,a;if(d(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),s=i[t]),void 0===s)s=i[t]=n,++e._eventsCount;else if("function"==typeof s?s=i[t]=o?[n,s]:[s,n]:o?s.unshift(n):s.push(n),(r=u(e))>0&&s.length>r&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var o={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=f.bind(o);return r.listener=n,o.wrapFn=r,r}function v(e,t,n){var o=e._events;if(void 0===o)return[];var r=o[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):h(r,r.length)}function g(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function h(e,t){for(var n=new Array(t),o=0;o<t;++o)n[o]=e[o];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return u(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var o="error"===e,r=this._events;if(void 0!==r)o=o&&void 0===r.error;else if(!o)return!1;if(o){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=r[e];if(void 0===c)return!1;if("function"==typeof c)i(c,this,t);else{var d=c.length,u=h(c,d);for(n=0;n<d;++n)i(u[n],this,t)}return!0},a.prototype.addListener=function(e,t){return l(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return l(this,e,t,!0)},a.prototype.once=function(e,t){return d(t),this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,o,r,i,s;if(d(t),void 0===(o=this._events))return this;if(void 0===(n=o[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){s=n[i].listener,r=i;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(o[e]=n[0]),void 0!==o.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,o;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,i=Object.keys(n);for(o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this},a.prototype.listeners=function(e){return v(this,e,!0)},a.prototype.rawListeners=function(e){return v(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},a.prototype.listenerCount=g,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]},t.default=a},591:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.sessions={},r.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||r.extension.isInstalled()}return!0};var o={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout((function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var o=new Error("NavigatorUserMediaError");o.name="You cancelled the request for permission, giving up...",n(o)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))}))}};function r(e){if((e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:r.noop,!r.initDone)return e.error("Library not initialized"),{};if(!r.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(r.log("Library initialized: "+r.initDone),!e.server)return e.error("Invalid server url"),{};var t=!1,o=null,i={},s=null,a=null,c=0,d=e.server;r.isArray(d)?(r.log("Multiple servers provided ("+d.length+"), will use the first that works"),d=null,a=e.server,r.debug(a)):0===d.indexOf("ws")?(t=!0,r.log("Using WebSockets to contact Janus: "+d)):(t=!1,r.log("Using REST API to contact Janus: "+d));var u=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=e.iceTransportPolicy,f=e.bundlePolicy,p=!0===e.ipv6,v=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(v=!0===e.withCredentials);var g=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(g=e.max_poll_events),g<1&&(g=1);var h=null;void 0!==e.token&&null!==e.token&&(h=e.token);var m=null;void 0!==e.apisecret&&null!==e.apisecret&&(m=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var b=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(b=e.keepAlivePeriod),isNaN(b)&&(b=25e3);var y=6e4;function S(e){var t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(y=e.longPollTimeout),isNaN(y)&&(y=6e4);var w=!1,k=null,_={},T=this,C=0,R={};function P(){if(null!=k)if(r.debug("Long poll..."),w){var t=d+"/"+k+"?rid="+(new Date).getTime();g&&(t=t+"&maxev="+g),h&&(t=t+"&token="+encodeURIComponent(h)),m&&(t=t+"&apisecret="+encodeURIComponent(m)),r.httpAPICall(t,{verb:"GET",withCredentials:v,success:A,timeout:y,error:function(t,n){if(r.error(t+":",n),++C>3)return w=!1,void e.error("Lost connection to the server (is it down?)");P()}})}else r.warn("Is the server down? (connected=false)")}function A(e,n){if(C=0,t||null==k||!0===n||P(),t||!r.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(d=e.sender))return void r.warn("Missing sender...");if(!(l=_[d]))return void r.debug("This handle is not attached to this session");var i=e.candidate;r.debug("Got a trickled candidate on session "+k),r.debug(i);var s=l.webrtcStuff;s.pc&&s.remoteSdp?(r.debug("Adding remote candidate:",i),i&&!0!==i.completed?s.pc.addIceCandidate(i):s.pc.addIceCandidate(r.endOfCandidates)):(r.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),s.candidates||(s.candidates=[]),s.candidates.push(i),r.debug(s.candidates))}else{if("webrtcup"===e.janus)return r.debug("Got a webrtcup event on session "+k),r.debug(e),(d=e.sender)?(l=_[d])?void l.webrtcState(!0):void r.debug("This handle is not attached to this session"):void r.warn("Missing sender...");if("hangup"===e.janus){if(r.debug("Got a hangup event on session "+k),r.debug(e),!(d=e.sender))return void r.warn("Missing sender...");if(!(l=_[d]))return void r.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.janus){if(r.debug("Got a detached event on session "+k),r.debug(e),!(d=e.sender))return void r.warn("Missing sender...");if(!(l=_[d]))return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.janus){if(r.debug("Got a media event on session "+k),r.debug(e),!(d=e.sender))return void r.warn("Missing sender...");if(!(l=_[d]))return void r.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(r.debug("Got a slowlink event on session "+k),r.debug(e),!(d=e.sender))return void r.warn("Missing sender...");if(!(l=_[d]))return void r.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.lost)}else{var a,c;if("error"===e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),r.debug(e),void((a=e.transaction)&&((c=R[a])&&c(e),delete R[a]));if("event"===e.janus){var d;if(r.debug("Got a plugin event on session "+k),r.debug(e),!(d=e.sender))return void r.warn("Missing sender...");var u=e.plugindata;if(!u)return void r.warn("Missing plugindata...");r.debug("  -- Event is coming from "+d+" ("+u.plugin+")");var l,f=u.data;if(r.debug(f),!(l=_[d]))return void r.warn("This handle is not attached to this session");var p=e.jsep;p&&(r.debug("Handling SDP as well..."),r.debug(p));var v=l.onmessage;v?(r.debug("Notifying application..."),v(f,p)):r.debug("No provided notification callback")}else{if("timeout"===e.janus)return r.error("Timeout on session "+k),r.debug(e),void(t&&o.close(3504,"Gateway timeout"));r.warn("Unknown message/event  '"+e.janus+"' on session "+k),r.debug(e)}}}else r.debug("Got a success on session "+k),r.debug(e),(a=e.transaction)&&((c=R[a])&&c(e),delete R[a]);else r.debug("Got an ack on session "+k),r.debug(e),(a=e.transaction)&&((c=R[a])&&c(e),delete R[a]);else r.debug("Got info on the Janus instance"),r.debug(e),(a=e.transaction)&&((c=R[a])&&c(e),delete R[a]);else r.vdebug("Got a keepalive on session "+k);else for(var g=0;g<e.length;g++)A(e[g],!0)}function D(){if(d&&t&&w){s=setTimeout(D,b);var e={janus:"keepalive",session_id:k,transaction:r.randomString(12)};h&&(e.token=h),m&&(e.apisecret=m),o.send(JSON.stringify(e))}}function I(n){var u=r.randomString(12),l={janus:"create",transaction:u};if(n.reconnect&&(w=!1,l.janus="claim",l.session_id=k,o&&(o.onopen=null,o.onerror=null,o.onclose=null,s&&(clearTimeout(s),s=null))),h&&(l.token=h),m&&(l.apisecret=m),!d&&r.isArray(a)&&(0===(d=a[c]).indexOf("ws")?(t=!0,r.log("Server #"+(c+1)+": trying WebSockets to contact Janus ("+d+")")):(t=!1,r.log("Server #"+(c+1)+": trying REST API to contact Janus ("+d+")"))),t)for(var f in o=r.newWebSocket(d,"janus-protocol"),i={error:function(){if(r.error("Error connecting to the Janus WebSockets server... "+d),r.isArray(a)&&!n.reconnect)return++c===a.length?void n.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){I(n)}),200));n.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){R[u]=function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void n.error(e.error.reason);s=setTimeout(D,b),w=!0,k=e.session_id?e.session_id:e.data.id,n.reconnect?r.log("Claimed session: "+k):r.log("Created session: "+k),r.sessions[k]=T,n.success()},o.send(JSON.stringify(l))},message:function(e){A(JSON.parse(e.data))},close:function(){d&&w&&(w=!1,e.error("Lost connection to the server (is it down?)"))}})o.addEventListener(f,i[f]);else r.httpAPICall(d,{verb:"POST",withCredentials:v,body:l,success:function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void n.error(e.error.reason);w=!0,k=e.session_id?e.session_id:e.data.id,n.reconnect?r.log("Claimed session: "+k):r.log("Created session: "+k),r.sessions[k]=T,P(),n.success()},error:function(e,t){if(r.error(e+":",t),r.isArray(a)&&!n.reconnect)return++c===a.length?void n.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){I(n)}),200));""===t?n.error(e+": Is the server down?"):n.error(e+": "+t)}})}function O(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop,!w)return r.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var i=_[e];if(!i||!i.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");var s=n.message,a=n.jsep,c=r.randomString(12),u={janus:"message",body:s,transaction:c};if(i.token&&(u.token=i.token),m&&(u.apisecret=m),a&&(u.jsep={type:a.type,sdp:a.sdp},a.e2ee&&(u.jsep.e2ee=!0),"hml"!==a.rid_order&&"lmh"!==a.rid_order||(u.jsep.rid_order=a.rid_order)),r.debug("Sending message to plugin (handle="+e+"):"),r.debug(u),t)return u.session_id=k,u.handle_id=e,R[c]=function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){var t=e.plugindata;if(!t)return r.warn("Request succeeded, but missing plugindata..."),void n.success();r.log("Synchronous transaction successful ("+t.plugin+")");var o=t.data;return r.debug(o),void n.success(o)}"ack"===e.janus?n.success():e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),n.error("Unknown error"))},void o.send(JSON.stringify(u));r.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:v,body:u,success:function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){var t=e.plugindata;if(!t)return r.warn("Request succeeded, but missing plugindata..."),void n.success();r.log("Synchronous transaction successful ("+t.plugin+")");var o=t.data;return r.debug(o),void n.success(o)}"ack"===e.janus?n.success():e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),n.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),n.error("Unknown error"))},error:function(e,t){r.error(e+":",t),n.error(e+": "+t)}})}function j(e,n){if(w){var i=_[e];if(i&&i.webrtcStuff){var s={janus:"trickle",candidate:n,transaction:r.randomString(12)};if(i.token&&(s.token=i.token),m&&(s.apisecret=m),r.vdebug("Sending trickle candidate (handle="+e+"):"),r.vdebug(s),t)return s.session_id=k,s.handle_id=e,void o.send(JSON.stringify(s));r.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:v,body:s,success:function(e){r.vdebug("Candidate sent!"),r.vdebug(e),"ack"===e.janus||r.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){r.error(e+":",t)}})}else r.warn("Invalid handle")}else r.warn("Is the server down? (connected=false)")}function x(e,t,n,o,i){var s=_[e];if(s&&s.webrtcStuff){var a=s.webrtcStuff;if(a.pc){var c=function(e){r.log("Received state change on data channel:",e);var t=e.target.label,n=e.target.protocol,o=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(r.log("State change on <"+t+"> data channel: "+o),"open"===o){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){r.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length);var i=!0,c=!1,d=void 0;try{for(var u,l=a.dataChannel[t].pending[Symbol.iterator]();!(i=(u=l.next()).done);i=!0){var f=u.value;r.log("Sending data on data channel <"+t+">"),r.debug(f),a.dataChannel[t].send(f)}}catch(e){c=!0,d=e}finally{try{!i&&l.return&&l.return()}finally{if(c)throw d}}a.dataChannel[t].pending=[]}s.ondataopen(t,n)}};if(o)a.dataChannel[t]=o;else{var d={ordered:!0};n&&(d.protocol=n),a.dataChannel[t]=a.pc.createDataChannel(t,d)}a.dataChannel[t].onmessage=function(e){r.log("Received message on data channel:",e);var t=e.target.label;s.ondata(e.data,t)},a.dataChannel[t].onopen=c,a.dataChannel[t].onclose=c,a.dataChannel[t].onerror=function(e){r.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],i&&a.dataChannel[t].pending.push(i)}else r.warn("Invalid PeerConnection")}else r.warn("Invalid handle")}function M(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=_[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff,i=t.text||t.data;if(!i)return r.warn("Invalid data"),void t.error("Invalid data");var s=t.label?t.label:r.dataChanDefaultLabel;return o.dataChannel[s]?"open"!==o.dataChannel[s].readyState?(o.dataChannel[s].pending.push(i),void t.success()):(r.log("Sending data on data channel <"+s+">"),r.debug(i),o.dataChannel[s].send(i),void t.success()):(x(e,s,t.protocol,!1,i,t.protocol),void t.success())}function E(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=_[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff;if(!o.dtmfSender){if(o.pc){var i=o.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!i)return r.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");o.dtmfSender=i.dtmf,o.dtmfSender&&(r.log("Created DTMF Sender"),o.dtmfSender.ontonechange=function(e){r.debug("Sent DTMF tone: "+e.tone)})}if(!o.dtmfSender)return r.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var s=t.dtmf;if(!s)return r.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var a=s.tones;if(!a)return r.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var c="number"==typeof s.duration?s.duration:500,d="number"==typeof s.gap?s.gap:50;r.debug("Sending DTMF string "+a+" (duration "+c+"ms, gap "+d+"ms)"),o.dtmfSender.insertDTMF(a,c,d),t.success()}function V(e,n){(n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop;var i=!0===n.noRequest;r.log("Destroying handle "+e+" (only-locally="+i+")"),B(e);var s=_[e];if(!s||s.detached)return delete _[e],void n.success();if(i)return delete _[e],void n.success();if(!w)return r.warn("Is the server down? (connected=false)"),void n.error("Is the server down? (connected=false)");var a={janus:"detach",transaction:r.randomString(12)};if(s.token&&(a.token=s.token),m&&(a.apisecret=m),t)return a.session_id=k,a.handle_id=e,o.send(JSON.stringify(a)),delete _[e],void n.success();r.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:v,body:a,success:function(t){r.log("Destroyed handle:"),r.debug(t),"success"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),delete _[e],n.success()},error:function(t,o){r.error(t+":",o),delete _[e],n.success()}})}function N(e,t,o,i,s){var a=_[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),i.stream||r.stopAllTracks(s),void i.error("Invalid handle");var c=a.webrtcStuff;r.debug("streamsDone:",s),s&&(r.debug("  -- Audio tracks:",s.getAudioTracks()),r.debug("  -- Video tracks:",s.getVideoTracks()));var d=!1;if(c.myStream&&o.update&&!c.streamExternal){if((!o.update&&q(o)||o.update&&(o.addAudio||o.replaceAudio))&&s.getAudioTracks()&&s.getAudioTracks().length)if(c.myStream.addTrack(s.getAudioTracks()[0]),r.unifiedPlan){r.log((o.replaceAudio?"Replacing":"Adding")+" audio track:",s.getAudioTracks()[0]);var v=null;if((w=c.pc.getTransceivers())&&w.length>0){var g=!0,h=!1,m=void 0;try{for(var b,y=w[Symbol.iterator]();!(g=(b=y.next()).done);g=!0)if((D=b.value).sender&&D.sender.track&&"audio"===D.sender.track.kind||D.receiver&&D.receiver.track&&"audio"===D.receiver.track.kind){v=D;break}}catch(e){h=!0,m=e}finally{try{!g&&y.return&&y.return()}finally{if(h)throw m}}}v&&v.sender?v.sender.replaceTrack(s.getAudioTracks()[0]):c.pc.addTrack(s.getAudioTracks()[0],s)}else r.log((o.replaceAudio?"Replacing":"Adding")+" audio track:",s.getAudioTracks()[0]),c.pc.addTrack(s.getAudioTracks()[0],s);if((!o.update&&K(o)||o.update&&(o.addVideo||o.replaceVideo))&&s.getVideoTracks()&&s.getVideoTracks().length)if(c.myStream.addTrack(s.getVideoTracks()[0]),r.unifiedPlan){r.log((o.replaceVideo?"Replacing":"Adding")+" video track:",s.getVideoTracks()[0]);var w,k=null;if((w=c.pc.getTransceivers())&&w.length>0){var T=!0,C=!1,R=void 0;try{for(var P,A=w[Symbol.iterator]();!(T=(P=A.next()).done);T=!0){var D;if((D=P.value).sender&&D.sender.track&&"video"===D.sender.track.kind||D.receiver&&D.receiver.track&&"video"===D.receiver.track.kind){k=D;break}}}catch(e){C=!0,R=e}finally{try{!T&&A.return&&A.return()}finally{if(C)throw R}}}k&&k.sender?k.sender.replaceTrack(s.getVideoTracks()[0]):c.pc.addTrack(s.getVideoTracks()[0],s)}else r.log((o.replaceVideo?"Replacing":"Adding")+" video track:",s.getVideoTracks()[0]),c.pc.addTrack(s.getVideoTracks()[0],s)}else c.myStream=s,d=!0;if(!c.pc){var I={iceServers:u,iceTransportPolicy:l,bundlePolicy:f};"chrome"===r.webRTCAdapter.browserDetails.browser&&(I.sdpSemantics=r.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var O={optional:[{DtlsSrtpKeyAgreement:!0}]};if(p&&O.optional.push({googIPv6:!0}),i.rtcConstraints&&"object"===n(i.rtcConstraints))for(var M in r.debug("Adding custom PeerConnection constraints:",i.rtcConstraints),i.rtcConstraints)O.optional.push(i.rtcConstraints[M]);"edge"===r.webRTCAdapter.browserDetails.browser&&(I.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(i.senderTransforms||i.receiverTransforms)&&(c.senderTransforms=i.senderTransforms,c.receiverTransforms=i.receiverTransforms,I.forceEncodedAudioInsertableStreams=!0,I.forceEncodedVideoInsertableStreams=!0,I.encodedInsertableStreams=!0),r.log("Creating PeerConnection"),r.debug(O),c.pc=new RTCPeerConnection(I,O),r.debug(c.pc),c.pc.getStats&&(c.volume={},c.bitrate.value="0 kbits/sec"),r.log("Preparing local SDP and gathering candidates (trickle="+c.trickle+")"),c.pc.oniceconnectionstatechange=function(e){c.pc&&a.iceState(c.pc.iceConnectionState)},c.pc.onicecandidate=function(t){if(!t.candidate||"edge"===r.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)r.log("End of candidates."),c.iceDone=!0,!0===c.trickle?j(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=_[e];if(n&&n.webrtcStuff){var o=n.webrtcStuff;r.log("Sending offer/answer SDP..."),o.mySdp?(o.mySdp={type:o.pc.localDescription.type,sdp:o.pc.localDescription.sdp},!1===o.trickle&&(o.mySdp.trickle=!1),r.debug(t),o.sdpSent=!0,t.success(o.mySdp)):r.warn("Local SDP instance is invalid, not sending anything...")}else r.warn("Invalid handle, not sending anything")}(e,i);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===c.trickle&&j(e,n)}},c.pc.ontrack=function(e){if(r.log("Handling Remote Track"),r.debug(e),e.streams&&(c.remoteStream=e.streams[0],a.onremotestream(c.remoteStream),!e.track.onended)){if(c.receiverTransforms){var t=null;RTCRtpSender.prototype.createEncodedStreams?t=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&c.receiverTransforms.audio?t=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&c.receiverTransforms.video&&(t=e.receiver.createEncodedVideoStreams())),t&&(console.log(t),t.readableStream&&t.writableStream?t.readableStream.pipeThrough(c.receiverTransforms[e.track.kind]).pipeTo(t.writableStream):t.readable&&t.writable&&t.readable.pipeThrough(c.receiverTransforms[e.track.kind]).pipeTo(t.writable))}var n=null;r.log("Adding onended callback to track:",e.track),e.track.onended=function(e){r.log("Remote track removed:",e),c.remoteStream&&(clearTimeout(n),c.remoteStream.removeTrack(e.target),a.onremotestream(c.remoteStream))},e.track.onmute=function(e){r.log("Remote track muted:",e),c.remoteStream&&null==n&&(n=setTimeout((function(){r.log("Removing remote track"),c.remoteStream&&(c.remoteStream.removeTrack(e.target),a.onremotestream(c.remoteStream)),n=null}),2520))},e.track.onunmute=function(e){if(r.log("Remote track flowing again:",e),null!=n)clearTimeout(n),n=null;else try{c.remoteStream.addTrack(e.target),a.onremotestream(c.remoteStream)}catch(e){r.error(e)}}}}}if(d&&s){r.log("Adding local stream");var E=!0===i.simulcast2;s.getTracks().forEach((function(e){r.log("Adding local track:",e);var t=null;if(E&&"audio"!==e.kind){r.log("Enabling rid-based simulcasting:",e);var n=S(i.simulcastMaxBitrates),o=c.pc.addTransceiver(e,{direction:"sendrecv",streams:[s],sendEncodings:i.sendEncodings||[{rid:"h",active:!0,maxBitrate:n.high},{rid:"m",active:!0,maxBitrate:n.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:n.low,scaleResolutionDownBy:4}]});o&&(t=o.sender)}else t=c.pc.addTrack(e,s);if(t&&c.senderTransforms){var a=null;RTCRtpSender.prototype.createEncodedStreams?a=t.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===t.track.kind&&c.senderTransforms.audio?a=t.createEncodedAudioStreams():"video"===t.track.kind&&c.senderTransforms.video&&(a=t.createEncodedVideoStreams())),a&&(console.log(a),a.readableStream&&a.writableStream?a.readableStream.pipeThrough(c.senderTransforms[t.track.kind]).pipeTo(a.writableStream):a.readable&&a.writable&&a.readable.pipeThrough(c.senderTransforms[t.track.kind]).pipeTo(a.writable))}}))}(function(e){return r.debug("isDataEnabled:",e),"edge"===r.webRTCAdapter.browserDetails.browser?(r.warn("Edge doesn't support data channels yet"),!1):null!=e&&!0===e.data})(o)&&!c.dataChannel[r.dataChanDefaultLabel]&&(r.log("Creating default data channel"),x(e,r.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){r.log("Data channel created by Janus:",t),x(e,t.channel.label,t.channel.protocol,t.channel)}),c.myStream&&a.onlocalstream(c.myStream),t?c.pc.setRemoteDescription(t).then((function(){if(r.log("Remote description accepted!"),c.remoteSdp=t.sdp,c.candidates&&c.candidates.length>0){for(var n=0;n<c.candidates.length;n++){var s=c.candidates[n];r.debug("Adding remote candidate:",s),s&&!0!==s.completed?c.pc.addIceCandidate(s):c.pc.addIceCandidate(r.endOfCandidates)}c.candidates=[]}!function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:r.noop;var o=_[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");var i=o.webrtcStuff,s=!0===n.simulcast;s?r.log("Creating answer (iceDone="+i.iceDone+", simulcast="+s+")"):r.log("Creating answer (iceDone="+i.iceDone+")");var a=null;if(r.unifiedPlan){a={};var c=null,d=null,u=i.pc.getTransceivers();if(u&&u.length>0){var l=!0,f=!1,p=void 0;try{for(var v,g=u[Symbol.iterator]();!(l=(v=g.next()).done);l=!0){var h=v.value;h.sender&&h.sender.track&&"audio"===h.sender.track.kind||h.receiver&&h.receiver.track&&"audio"===h.receiver.track.kind?c||(c=h):(h.sender&&h.sender.track&&"video"===h.sender.track.kind||h.receiver&&h.receiver.track&&"video"===h.receiver.track.kind)&&(d||(d=h))}}catch(e){f=!0,p=e}finally{try{!l&&g.return&&g.return()}finally{if(f)throw p}}}var m=q(t),b=z(t);if(m||b){if(m&&b){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",r.log("Setting audio transceiver to sendrecv:",c)}catch(e){r.error(e)}}else if(m&&!b)try{c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",r.log("Setting audio transceiver to sendonly:",c))}catch(e){r.error(e)}else if(!m&&b)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",r.log("Setting audio transceiver to recvonly:",c)}catch(e){r.error(e)}else c=i.pc.addTransceiver("audio",{direction:"recvonly"}),r.log("Adding recvonly audio transceiver:",c)}else if(t.removeAudio&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",r.log("Setting audio transceiver to inactive:",c)}catch(e){r.error(e)}var y=K(t),w=Q(t);if(y||w){if(y&&w){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",r.log("Setting video transceiver to sendrecv:",d)}catch(e){r.error(e)}}else if(y&&!w){if(d)try{d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",r.log("Setting video transceiver to sendonly:",d)}catch(e){r.error(e)}}else if(!y&&w)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",r.log("Setting video transceiver to recvonly:",d)}catch(e){r.error(e)}else d=i.pc.addTransceiver("video",{direction:"recvonly"}),r.log("Adding recvonly video transceiver:",d)}else if(t.removeVideo&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",r.log("Setting video transceiver to inactive:",d)}catch(e){r.error(e)}}else a="firefox"===r.webRTCAdapter.browserDetails.browser||"edge"===r.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:z(t),offerToReceiveVideo:Q(t)}:{mandatory:{OfferToReceiveAudio:z(t),OfferToReceiveVideo:Q(t)}};r.debug(a);var k=K(t);if(k&&s&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Enabling Simulcasting for Firefox (RID)");var T=i.pc.getSenders()[1];r.log(T);var C=T.getParameters();r.log(C);var R=S(n.simulcastMaxBitrates);T.setParameters({encodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:R.high},{rid:"m",active:!0,maxBitrate:R.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:R.low,scaleResolutionDownBy:4}]})}i.pc.createAnswer(a).then((function(e){r.debug(e);var t={type:e.type,sdp:e.sdp};n.customizeSdp(t),e.sdp=t.sdp,r.log("Setting local description"),k&&s&&("chrome"===r.webRTCAdapter.browserDetails.browser?r.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==r.webRTCAdapter.browserDetails.browser&&r.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp={type:"answer",sdp:e.sdp},i.pc.setLocalDescription(e).catch(n.error),i.mediaConstraints=a,i.iceDone||i.trickle?((i.senderTransforms||i.receiverTransforms)&&(e.e2ee=!0),n.success(e)):r.log("Waiting for all candidates...")}),n.error)}(e,o,i)}),i.error):function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:r.noop;var o=_[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");var i=o.webrtcStuff,s=!0===n.simulcast;s?r.log("Creating offer (iceDone="+i.iceDone+", simulcast="+s+")"):r.log("Creating offer (iceDone="+i.iceDone+")");var a={};if(r.unifiedPlan){var c=null,d=null,u=i.pc.getTransceivers();if(u&&u.length>0){var l=!0,f=!1,p=void 0;try{for(var v,g=u[Symbol.iterator]();!(l=(v=g.next()).done);l=!0){var h=v.value;h.sender&&h.sender.track&&"audio"===h.sender.track.kind||h.receiver&&h.receiver.track&&"audio"===h.receiver.track.kind?c||(c=h):(h.sender&&h.sender.track&&"video"===h.sender.track.kind||h.receiver&&h.receiver.track&&"video"===h.receiver.track.kind)&&(d||(d=h))}}catch(e){f=!0,p=e}finally{try{!l&&g.return&&g.return()}finally{if(f)throw p}}}var m=q(t),b=z(t);m||b?m&&b?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",r.log("Setting audio transceiver to sendrecv:",c)):m&&!b?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",r.log("Setting audio transceiver to sendonly:",c)):!m&&b&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",r.log("Setting audio transceiver to recvonly:",c)):(c=i.pc.addTransceiver("audio",{direction:"recvonly"}),r.log("Adding recvonly audio transceiver:",c))):t.removeAudio&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",r.log("Setting audio transceiver to inactive:",c));var y=K(t),w=Q(t);y||w?y&&w?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",r.log("Setting video transceiver to sendrecv:",d)):y&&!w?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",r.log("Setting video transceiver to sendonly:",d)):!y&&w&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",r.log("Setting video transceiver to recvonly:",d)):(d=i.pc.addTransceiver("video",{direction:"recvonly"}),r.log("Adding recvonly video transceiver:",d))):t.removeVideo&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",r.log("Setting video transceiver to inactive:",d))}else a.offerToReceiveAudio=z(t),a.offerToReceiveVideo=Q(t);!0===n.iceRestart&&(a.iceRestart=!0),r.debug(a);var k=K(t);if(k&&s&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Enabling Simulcasting for Firefox (RID)");var T=i.pc.getSenders().find((function(e){return"video"===e.track.kind}));if(T){var C=T.getParameters();C||(C={});var R=S(n.simulcastMaxBitrates);C.encodings=n.sendEncodings||[{rid:"h",active:!0,maxBitrate:R.high},{rid:"m",active:!0,maxBitrate:R.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:R.low,scaleResolutionDownBy:4}],T.setParameters(C)}}i.pc.createOffer(a).then((function(e){r.debug(e);var t={type:e.type,sdp:e.sdp};n.customizeSdp(t),e.sdp=t.sdp,r.log("Setting local description"),k&&s&&("chrome"===r.webRTCAdapter.browserDetails.browser||"safari"===r.webRTCAdapter.browserDetails.browser?(r.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),n=!1,o=[-1],i=[-1],s=null,a=null,c=null,d=null,u=-1,l=0;l<t.length;l++)if(p=t[l].match(/m=(\w+) */)){if("video"===p[1]){if(!(o[0]<0)){u=l;break}n=!0}else if(o[0]>-1){u=l;break}}else if(n){if(t[l].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/))return r.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var f=t[l].match(/a=ssrc-group:FID (\d+) (\d+)/);if(f)o[0]=f[1],i[0]=f[2],t.splice(l,1),l--;else{if(o[0]){if((g=t[l].match("a=ssrc:"+o[0]+" cname:(.+)"))&&(s=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" msid:(.+)"))&&(a=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" mslabel:(.+)"))&&(c=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" label:(.+)"))&&(d=g[1]),0===t[l].indexOf("a=ssrc:"+i[0])){t.splice(l,1),l--;continue}if(0===t[l].indexOf("a=ssrc:"+o[0])){t.splice(l,1),l--;continue}}0!=t[l].length||(t.splice(l,1),l--)}}if(o[0]<0)for(u=-1,n=!1,l=0;l<t.length;l++){var p;if(p=t[l].match(/m=(\w+) */)){if("video"===p[1]){if(!(o[0]<0)){u=l;break}n=!0}else if(o[0]>-1){u=l;break}}else if(n){if(o[0]<0){var v=t[l].match(/a=ssrc:(\d+)/);if(v){o[0]=v[1],t.splice(l,1),l--;continue}}else{var g;if((g=t[l].match("a=ssrc:"+o[0]+" cname:(.+)"))&&(s=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" msid:(.+)"))&&(a=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" mslabel:(.+)"))&&(c=g[1]),(g=t[l].match("a=ssrc:"+o[0]+" label:(.+)"))&&(d=g[1]),0===t[l].indexOf("a=ssrc:"+i[0])){t.splice(l,1),l--;continue}if(0===t[l].indexOf("a=ssrc:"+o[0])){t.splice(l,1),l--;continue}}0!==t[l].length||(t.splice(l,1),l--)}}if(o[0]<0)return r.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;for(u<0&&(u=t.length),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random()),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random()),l=0;l<o.length;l++)s&&(t.splice(u,0,"a=ssrc:"+o[l]+" cname:"+s),u++),a&&(t.splice(u,0,"a=ssrc:"+o[l]+" msid:"+a),u++),c&&(t.splice(u,0,"a=ssrc:"+o[l]+" mslabel:"+c),u++),d&&(t.splice(u,0,"a=ssrc:"+o[l]+" label:"+d),u++),s&&(t.splice(u,0,"a=ssrc:"+i[l]+" cname:"+s),u++),a&&(t.splice(u,0,"a=ssrc:"+i[l]+" msid:"+a),u++),c&&(t.splice(u,0,"a=ssrc:"+i[l]+" mslabel:"+c),u++),d&&(t.splice(u,0,"a=ssrc:"+i[l]+" label:"+d),u++);return t.splice(u,0,"a=ssrc-group:FID "+o[2]+" "+i[2]),t.splice(u,0,"a=ssrc-group:FID "+o[1]+" "+i[1]),t.splice(u,0,"a=ssrc-group:FID "+o[0]+" "+i[0]),t.splice(u,0,"a=ssrc-group:SIM "+o[0]+" "+o[1]+" "+o[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n"),e}(e.sdp)):"firefox"!==r.webRTCAdapter.browserDetails.browser&&r.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),i.mySdp={type:"offer",sdp:e.sdp},i.pc.setLocalDescription(e).catch(n.error),i.mediaConstraints=a,i.iceDone||i.trickle?((i.senderTransforms||i.receiverTransforms)&&(e.e2ee=!0),n.success(e)):r.log("Waiting for all candidates...")}),n.error)}(e,o,i)}function U(e,t,o){(o=o||{}).success="function"==typeof o.success?o.success:r.noop,o.error="function"==typeof o.error?o.error:G;var i=o.jsep;if(t&&i)return r.error("Provided a JSEP to a createOffer"),void o.error("Provided a JSEP to a createOffer");if(!(t||i&&i.type&&i.sdp))return r.error("A valid JSEP is required for createAnswer"),void o.error("A valid JSEP is required for createAnswer");o.media="object"===n(o.media)&&o.media?o.media:{audio:!0,video:!0};var s=o.media,a=_[e];if(!a||!a.webrtcStuff)return r.warn("Invalid handle"),void o.error("Invalid handle");var c,d=a.webrtcStuff;if(d.trickle=(c=o.trickle,r.debug("isTrickleEnabled:",c),!1!==c),d.pc){if(r.log("Updating existing media session"),s.update=!0,o.stream)o.stream!==d.myStream&&r.log("Renegotiation involves a new external stream");else{if(s.addAudio){if(s.keepAudio=!1,s.replaceAudio=!1,s.removeAudio=!1,s.audioSend=!0,d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length)return r.error("Can't add audio stream, there already is one"),void o.error("Can't add audio stream, there already is one")}else s.removeAudio?(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!1,s.audioSend=!1):s.replaceAudio&&(s.keepAudio=!1,s.addAudio=!1,s.removeAudio=!1,s.audioSend=!0);if(d.myStream&&d.myStream.getAudioTracks()&&0!==d.myStream.getAudioTracks().length?!q(s)||s.removeAudio||s.replaceAudio||(s.keepAudio=!0):(s.replaceAudio&&(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!0,s.audioSend=!0),q(s)&&(s.keepAudio=!1,s.addAudio=!0)),s.addVideo){if(s.keepVideo=!1,s.replaceVideo=!1,s.removeVideo=!1,s.videoSend=!0,d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length)return r.error("Can't add video stream, there already is one"),void o.error("Can't add video stream, there already is one")}else s.removeVideo?(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!1,s.videoSend=!1):s.replaceVideo&&(s.keepVideo=!1,s.addVideo=!1,s.removeVideo=!1,s.videoSend=!0);d.myStream&&d.myStream.getVideoTracks()&&0!==d.myStream.getVideoTracks().length?!K(s)||s.removeVideo||s.replaceVideo||(s.keepVideo=!0):(s.replaceVideo&&(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!0,s.videoSend=!0),K(s)&&(s.keepVideo=!1,s.addVideo=!0)),s.addData&&(s.data=!0)}if(q(s)&&s.keepAudio&&K(s)&&s.keepVideo)return a.consentDialog(!1),void N(e,i,s,o,d.myStream)}else s.update=!1,s.keepAudio=!1,s.keepVideo=!1;if(s.update&&!d.streamExternal){if(s.removeAudio||s.replaceAudio){if(d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length){var u=d.myStream.getAudioTracks()[0];r.log("Removing audio track:",u),d.myStream.removeTrack(u);try{u.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var l=!0;if(s.replaceAudio&&r.unifiedPlan&&(l=!1),l){var f=!0,p=!1,v=void 0;try{for(var g,h=d.pc.getSenders()[Symbol.iterator]();!(f=(g=h.next()).done);f=!0){var m=g.value;m&&m.track&&"audio"===m.track.kind&&(r.log("Removing audio sender:",m),d.pc.removeTrack(m))}}catch(e){p=!0,v=e}finally{try{!f&&h.return&&h.return()}finally{if(p)throw v}}}}}if(s.removeVideo||s.replaceVideo){if(d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length){var b=d.myStream.getVideoTracks()[0];r.log("Removing video track:",b),d.myStream.removeTrack(b);try{b.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var y=!0;if(s.replaceVideo&&r.unifiedPlan&&(y=!1),y){var S=!0,w=!1,k=void 0;try{for(var T,C=d.pc.getSenders()[Symbol.iterator]();!(S=(T=C.next()).done);S=!0){var R=T.value;R&&R.track&&"video"===R.track.kind&&(r.log("Removing video sender:",R),d.pc.removeTrack(R))}}catch(e){w=!0,k=e}finally{try{!S&&C.return&&C.return()}finally{if(w)throw k}}}}}}if(o.stream){var P=o.stream;return r.log("MediaStream provided by the application"),r.debug(P),s.update&&d.myStream&&d.myStream!==o.stream&&!d.streamExternal&&(r.stopAllTracks(d.myStream),d.myStream=null),d.streamExternal=!0,a.consentDialog(!1),void N(e,i,s,o,P)}if(q(s)||K(s)){if(!r.isGetUserMediaAvailable())return void o.error("getUserMedia not available");var A={mandatory:{},optional:[]};a.consentDialog(!0);var D=q(s);D&&s&&"object"===n(s.audio)&&(D=s.audio);var I=K(s);if(I&&s){var O=!0===o.simulcast,j=!0===o.simulcast2;if(!O&&!j||i||s.video||(s.video="hires"),s.video&&"screen"!=s.video&&"window"!=s.video)if("object"===n(s.video))I=s.video;else{var x=0,M=0;"lowres"===s.video?(M=240,x=320):"lowres-16:9"===s.video?(M=180,x=320):"hires"===s.video||"hires-16:9"===s.video||"hdres"===s.video?(M=720,x=1280):"fhdres"===s.video?(M=1080,x=1920):"4kres"===s.video?(M=2160,x=3840):"stdres"===s.video?(M=480,x=640):"stdres-16:9"===s.video?(M=360,x=640):(r.log("Default video setting is stdres 4:3"),M=480,x=640),r.log("Adding media constraint:",s.video),I={height:{ideal:M},width:{ideal:x}},r.log("Adding video constraint:",I)}else if("screen"===s.video||"window"===s.video){var E=function(t,n){a.consentDialog(!1),t?o.error(t):N(e,i,s,o,n)},V=function(e,t,n){r.log("Adding media constraint (screen capture)"),r.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)})):t(null,e)})).catch((function(e){a.consentDialog(!1),t(e)}))};if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return A.video={},s.screenshareFrameRate&&(A.video.frameRate=s.screenshareFrameRate),s.screenshareHeight&&(A.video.height=s.screenshareHeight),s.screenshareWidth&&(A.video.width=s.screenshareWidth),A.audio=s.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(A).then((function(t){a.consentDialog(!1),q(s)&&!s.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){t.addTrack(n.getAudioTracks()[0]),N(e,i,s,o,t)})):N(e,i,s,o,t)}),(function(e){a.consentDialog(!1),o.error(e)}));if("chrome"===r.webRTCAdapter.browserDetails.browser){var U=r.webRTCAdapter.browserDetails.version,L=33;window.navigator.userAgent.match("Linux")&&(L=35),U>=26&&U<=L?(A={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate,chromeMediaSource:"screen"}},audio:q(s)&&!s.keepAudio},V(A,E)):r.extension.getScreen((function(e,t){if(e)return a.consentDialog(!1),o.error(e);(A={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=t,V(A,E,q(s)&&!s.keepAudio)}))}else if("firefox"===r.webRTCAdapter.browserDetails.browser){if(!(r.webRTCAdapter.browserDetails.version>=33)){var J=new Error("NavigatorUserMediaError");return J.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void o.error(J)}A={video:{mozMediaSource:s.video,mediaSource:s.video},audio:q(s)&&!s.keepAudio},V(A,(function(e,t){if(E(e,t),!e)var n=t.currentTime,o=window.setInterval((function(){t||window.clearInterval(o),t.currentTime==n&&(window.clearInterval(o),t.onended&&t.onended()),n=t.currentTime}),500)}))}return}}s&&"screen"===s.video||navigator.mediaDevices.enumerateDevices().then((function(t){var c=t.some((function(e){return"audioinput"===e.kind})),d=function(e){if(r.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!==n(e.video)||"object"!==n(e.video.mandatory))return!1;var t=e.video.mandatory;return t.chromeMediaSource?"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource:t.mozMediaSource?"window"===t.mozMediaSource||"screen"===t.mozMediaSource:!!t.mediaSource&&("window"===t.mediaSource||"screen"===t.mediaSource)}(s)||t.some((function(e){return"videoinput"===e.kind})),u=q(s),l=K(s),f=function(e){return r.debug("isAudioSendRequired:",e),!!e&&!1!==e.audio&&!1!==e.audioSend&&void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio}(s),p=function(e){return r.debug("isVideoSendRequired:",e),!!e&&!1!==e.video&&!1!==e.videoSend&&void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo}(s);if(u||l||f||p){var v=!!u&&c,g=!!l&&d;if(!v&&!g)return a.consentDialog(!1),o.error("No capture device found"),!1;if(!v&&f)return a.consentDialog(!1),o.error("Audio capture is required, but no capture device found"),!1;if(!g&&p)return a.consentDialog(!1),o.error("Video capture is required, but no capture device found"),!1}var h={audio:!(!c||s.keepAudio)&&D,video:!(!d||s.keepVideo)&&I};r.debug("getUserMedia constraints",h),h.audio||h.video?navigator.mediaDevices.getUserMedia(h).then((function(t){a.consentDialog(!1),N(e,i,s,o,t)})).catch((function(e){a.consentDialog(!1),o.error({code:e.code,name:e.name,message:e.message})})):(a.consentDialog(!1),N(e,i,s,o,P))})).catch((function(e){a.consentDialog(!1),o.error(e)}))}else N(e,i,s,o)}function L(e,t){(t=t||{}).success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:G,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:r.noop;var n=t.jsep,o=_[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var i=o.webrtcStuff;if(n){if(!i.pc)return r.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(n),i.pc.setRemoteDescription(n).then((function(){if(r.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&i.candidates.length>0){for(var e=0;e<i.candidates.length;e++){var o=i.candidates[e];r.debug("Adding remote candidate:",o),o&&!0!==o.completed?i.pc.addIceCandidate(o):i.pc.addIceCandidate(r.endOfCandidates)}i.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}function J(e,t){var n=_[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),0;var o=t?"remote":"local",i=n.webrtcStuff;return i.volume[o]||(i.volume[o]={value:0}),!i.pc.getStats||"chrome"!==r.webRTCAdapter.browserDetails.browser&&"safari"!==r.webRTCAdapter.browserDetails.browser?(r.warn("Getting the "+o+" volume unsupported by browser"),0):t&&!i.remoteStream?(r.warn("Remote stream unavailable"),0):t||i.myStream?i.volume[o].timer?i.volume[o].value:(r.log("Starting "+o+" volume monitor"),i.volume[o].timer=setInterval((function(){i.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(t&&!e.remoteSource||!t&&"media-source"!==e.type||(i.volume[o].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(r.warn("Local stream unavailable"),0)}function W(e,t){var n=_[e];if(!n||!n.webrtcStuff)return r.warn("Invalid handle"),!0;var o=n.webrtcStuff;return o.pc?o.myStream?t?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?!o.myStream.getVideoTracks()[0].enabled:(r.warn("No video track"),!0):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?!o.myStream.getAudioTracks()[0].enabled:(r.warn("No audio track"),!0):(r.warn("Invalid local MediaStream"),!0):(r.warn("Invalid PeerConnection"),!0)}function H(e,t,n){var o=_[e];if(!o||!o.webrtcStuff)return r.warn("Invalid handle"),!1;var i=o.webrtcStuff;return i.pc?i.myStream?t?i.myStream.getVideoTracks()&&0!==i.myStream.getVideoTracks().length?(i.myStream.getVideoTracks()[0].enabled=!n,!0):(r.warn("No video track"),!1):i.myStream.getAudioTracks()&&0!==i.myStream.getAudioTracks().length?(i.myStream.getAudioTracks()[0].enabled=!n,!0):(r.warn("No audio track"),!1):(r.warn("Invalid local MediaStream"),!1):(r.warn("Invalid PeerConnection"),!1)}function F(e){var t=_[e];if(!t||!t.webrtcStuff)return r.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return n.pc?n.pc.getStats?n.bitrate.timer?n.bitrate.value:(r.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval((function(){n.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var o=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"===r.webRTCAdapter.browserDetails.browser&&(o/=1e3);var i=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/o);"safari"===r.webRTCAdapter.browserDetails.browser&&(i=parseInt(i/1e3)),n.bitrate.value=i+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(r.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function G(e){r.error("WebRTC error:",e)}function B(e,n){r.log("Cleaning WebRTC stuff");var i=_[e];if(i){var s=i.webrtcStuff;if(s){if(!0===n){var a={janus:"hangup",transaction:r.randomString(12)};i.token&&(a.token=i.token),m&&(a.apisecret=m),r.debug("Sending hangup request (handle="+e+"):"),r.debug(a),t?(a.session_id=k,a.handle_id=e,o.send(JSON.stringify(a))):r.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:v,body:a})}s.remoteStream=null,s.volume&&(s.volume.local&&s.volume.local.timer&&clearInterval(s.volume.local.timer),s.volume.remote&&s.volume.remote.timer&&clearInterval(s.volume.remote.timer)),s.volume={},s.bitrate.timer&&clearInterval(s.bitrate.timer),s.bitrate.timer=null,s.bitrate.bsnow=null,s.bitrate.bsbefore=null,s.bitrate.tsnow=null,s.bitrate.tsbefore=null,s.bitrate.value=null,!s.streamExternal&&s.myStream&&(r.log("Stopping local stream tracks"),r.stopAllTracks(s.myStream)),s.streamExternal=!1,s.myStream=null;try{s.pc.close()}catch(e){}s.pc=null,s.candidates=null,s.mySdp=null,s.remoteSdp=null,s.iceDone=!1,s.dataChannel={},s.dtmfSender=null,s.senderTransforms=null,s.receiverTransforms=null}i.oncleanup()}}function q(e){return r.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function z(e){return r.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function K(e){return r.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function Q(e){return r.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}I(e),this.getServer=function(){return d},this.isConnected=function(){return w},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.reconnect=!0,I(e)},this.getSessionId=function(){return k},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,r.log("Getting info on Janus instance"),!w)return r.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=r.randomString(12),i={janus:"info",transaction:n};if(h&&(i.token=h),m&&(i.apisecret=m),t)return R[n]=function(t){r.log("Server info:"),r.debug(t),"server_info"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void o.send(JSON.stringify(i));r.httpAPICall(d,{verb:"POST",withCredentials:v,body:i,success:function(t){r.log("Server info:"),r.debug(t),"server_info"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,n){r.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)},this.destroy=function(n){!function(n){(n=n||{}).success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop;var a=!0===n.unload,c=!0;void 0!==n.notifyDestroyed&&null!==n.notifyDestroyed&&(c=!0===n.notifyDestroyed);var u=!0===n.cleanupHandles;if(r.log("Destroying session "+k+" (unload="+a+")"),!k)return r.warn("No session to destroy"),n.success(),void(c&&e.destroyed());if(u)for(var l in _)V(l,{noRequest:!0});if(!w)return r.warn("Is the server down? (connected=false)"),k=null,void n.success();var f={janus:"destroy",transaction:r.randomString(12)};if(h&&(f.token=h),m&&(f.apisecret=m),a)return t?(o.onclose=null,o.close(),o=null):navigator.sendBeacon(d+"/"+k,JSON.stringify(f)),r.log("Destroyed session:"),k=null,w=!1,n.success(),void(c&&e.destroyed());if(t){f.session_id=k;var p=function(){for(var e in i)o.removeEventListener(e,i[e]);o.removeEventListener("message",g),o.removeEventListener("error",b),s&&clearTimeout(s),o.close()},g=function(t){var o=JSON.parse(t.data);o.session_id==f.session_id&&o.transaction==f.transaction&&(p(),n.success(),c&&e.destroyed())},b=function(t){p(),n.error("Failed to destroy the server: Is the server down?"),c&&e.destroyed()};return o.addEventListener("message",g),o.addEventListener("error",b),void(1===o.readyState?o.send(JSON.stringify(f)):b())}r.httpAPICall(d+"/"+k,{verb:"POST",withCredentials:v,body:f,success:function(t){r.log("Destroyed session:"),r.debug(t),k=null,w=!1,"success"!==t.janus&&r.error("Ooops: "+t.error.code+" "+t.error.reason),n.success(),c&&e.destroyed()},error:function(t,o){r.error(t+":",o),k=null,w=!1,n.success(),c&&e.destroyed()}})}(n)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:r.noop,e.iceState="function"==typeof e.iceState?e.iceState:r.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:r.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:r.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:r.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:r.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:r.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:r.noop,e.ondata="function"==typeof e.ondata?e.ondata:r.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:r.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:r.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:r.noop,!w)return r.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var n=e.plugin;if(!n)return r.error("Invalid plugin"),void e.error("Invalid plugin");var i=e.opaqueId,s=e.token?e.token:h,a=r.randomString(12),c={janus:"attach",plugin:n,opaque_id:i,transaction:a};if(s&&(c.token=s),m&&(c.apisecret=m),t)return R[a]=function(t){if(r.debug(t),"success"!==t.janus)return r.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var o=t.data.id;r.log("Created handle: "+o);var i={session:T,plugin:n,id:o,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return o},getPlugin:function(){return n},getVolume:function(){return J(o,!0)},getRemoteVolume:function(){return J(o,!0)},getLocalVolume:function(){return J(o,!1)},isAudioMuted:function(){return W(o,!1)},muteAudio:function(){return H(o,!1,!0)},unmuteAudio:function(){return H(o,!1,!1)},isVideoMuted:function(){return W(o,!0)},muteVideo:function(){return H(o,!0,!0)},unmuteVideo:function(){return H(o,!0,!1)},getBitrate:function(){return F(o)},send:function(e){O(o,e)},data:function(e){M(o,e)},dtmf:function(e){E(o,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){U(o,!0,e)},createAnswer:function(e){U(o,!1,e)},handleRemoteJsep:function(e){L(o,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){B(o,!0===e)},detach:function(e){V(o,e)}};_[o]=i,e.success(i)},c.session_id=k,void o.send(JSON.stringify(c));r.httpAPICall(d+"/"+k,{verb:"POST",withCredentials:v,body:c,success:function(t){if(r.debug(t),"success"!==t.janus)return r.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var o=t.data.id;r.log("Created handle: "+o);var i={session:T,plugin:n,id:o,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return o},getPlugin:function(){return n},getVolume:function(){return J(o,!0)},getRemoteVolume:function(){return J(o,!0)},getLocalVolume:function(){return J(o,!1)},isAudioMuted:function(){return W(o,!1)},muteAudio:function(){return H(o,!1,!0)},unmuteAudio:function(){return H(o,!1,!1)},isVideoMuted:function(){return W(o,!0)},muteVideo:function(){return H(o,!0,!0)},unmuteVideo:function(){return H(o,!0,!1)},getBitrate:function(){return F(o)},send:function(e){O(o,e)},data:function(e){M(o,e)},dtmf:function(e){E(o,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){U(o,!0,e)},createAnswer:function(e){U(o,!1,e)},handleRemoteJsep:function(e){L(o,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){B(o,!0===e)},detach:function(e){V(o,e)}};_[o]=i,e.success(i)},error:function(t,n){r.error(t+":",n),""===n?e.error(t+": Is the server down?"):e.error(t+": "+n)}})}(e)}}r.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,i=e&&e.Promise||Promise,s=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new s(e,t)},extension:e&&e.extension||o,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,o){var s={method:o.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===o.verb&&(s.headers["Content-Type"]="application/json"),void 0!==o.withCredentials&&(s.credentials=!0===o.withCredentials?"include":o.withCredentials?o.withCredentials:"omit"),o.body&&(s.body=JSON.stringify(o.body));var a=t(e,s).catch((function(e){return i.reject({message:"Probably a network error, is the server down?",error:e})}));if(o.timeout){var c=new i((function(e,t){var n=setTimeout((function(){return clearTimeout(n),t({message:"Request timed out",timeout:o.timeout})}),o.timeout)}));a=i.race([a,c])}return a.then((function(e){return e.ok?n(o.success)===n(r.noop)?e.json().then((function(e){o.success(e)})).catch((function(t){return i.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:i.reject({message:"API call failed",response:e})})).catch((function(e){n(o.error)===n(r.noop)&&o.error(e.message||"<< internal error >>",e)})),a}}},r.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,i=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||o,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,o){var i=void 0!==o.body?{contentType:"application/json",data:JSON.stringify(o.body)}:{},s=void 0!==o.withCredentials?{xhrFields:{withCredentials:o.withCredentials}}:{};return t.ajax(t.extend(i,s,{url:e,type:o.verb,cache:!1,dataType:"json",async:o.async,timeout:o.timeout,success:function(e){n(o.success)===n(r.noop)&&o.success(e)},error:function(e,t,i){n(o.error)===n(r.noop)&&o.error(t,i)}}))}}},r.noop=function(){},r.dataChanDefaultLabel="JanusDataChannel",r.endOfCandidates=null,r.stopAllTracks=function(e){try{var t=e.getTracks(),n=!0,o=!1,i=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var c=s.value;r.log(c),c&&c.stop()}}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}}catch(e){}},r.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:r.noop,r.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),r.trace=r.noop,r.debug=r.noop,r.vdebug=r.noop,r.log=r.noop,r.warn=r.noop,r.error=r.noop,!0===e.debug||"all"===e.debug)r.trace=console.trace.bind(console),r.debug=console.debug.bind(console),r.vdebug=console.debug.bind(console),r.log=console.log.bind(console),r.warn=console.warn.bind(console),r.error=console.error.bind(console);else if(Array.isArray(e.debug)){var t=!0,n=!1,o=void 0;try{for(var i,s=e.debug[Symbol.iterator]();!(t=(i=s.next()).done);t=!0){var a=i.value;switch(a){case"trace":r.trace=console.trace.bind(console);break;case"debug":r.debug=console.debug.bind(console);break;case"vdebug":r.vdebug=console.debug.bind(console);break;case"log":r.log=console.log.bind(console);break;case"warn":r.warn=console.warn.bind(console);break;case"error":r.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+a+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}}catch(e){n=!0,o=e}finally{try{!t&&s.return&&s.return()}finally{if(n)throw o}}}r.log("Initializing library");var c=e.dependencies||r.useDefaultDependencies();r.isArray=c.isArray,r.webRTCAdapter=c.webRTCAdapter,r.httpAPICall=c.httpAPICall,r.newWebSocket=c.newWebSocket,r.extension=c.extension,r.extension.init(),r.listDevices=function(e,t){e="function"==typeof e?e:r.noop,null==t&&(t={audio:!0,video:!0}),r.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(n){r.debug(n),e(n),r.stopAllTracks(t)}))})).catch((function(t){r.error(t),e([])})):(r.warn("navigator.mediaDevices unavailable"),e([]))},r.attachMediaStream=function(e,t){try{e.srcObject=t}catch(n){try{e.src=URL.createObjectURL(t)}catch(e){r.error("Error attaching stream to element")}}},r.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(n){try{e.src=t.src}catch(e){r.error("Error reattaching stream to element")}}};var d=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",u=window["on"+d];if(window.addEventListener(d,(function(e){for(var t in r.log("Closing window"),r.sessions)r.sessions[t]&&r.sessions[t].destroyOnUnload&&(r.log("Destroying session "+t),r.sessions[t].destroy({unload:!0,notifyDestroyed:!1}));u&&"function"==typeof u&&u()})),r.safariVp8=!1,"safari"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){var l=!0,f=!1,p=void 0;try{for(var v,g=RTCRtpSender.getCapabilities("video").codecs[Symbol.iterator]();!(l=(v=g.next()).done);l=!0){var h=v.value;if(h&&h.mimeType&&"video/vp8"===h.mimeType.toLowerCase()){r.safariVp8=!0;break}}}catch(e){f=!0,p=e}finally{try{!l&&g.return&&g.return()}finally{if(f)throw p}}r.safariVp8?r.log("This version of Safari supports VP8"):r.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var m=new RTCPeerConnection({});m.createOffer({offerToReceiveVideo:!0}).then((function(e){r.safariVp8=-1!==e.sdp.indexOf("VP8"),r.safariVp8?r.log("This version of Safari supports VP8"):r.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),m.close(),m=null}))}if(r.unifiedPlan=!1,"firefox"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=59)r.unifiedPlan=!0;else if("chrome"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=72)r.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var b=new RTCPeerConnection;try{b.addTransceiver("audio"),r.unifiedPlan=!0}catch(e){}b.close()}else r.unifiedPlan=!1;r.initDone=!0,e.callback()}},r.isWebrtcSupported=function(){return!!window.RTCPeerConnection},r.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},r.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",o=0;o<e;o++){var r=Math.floor(Math.random()*t.length);n+=t.substring(r,r+1)}return n},t.default=r},325:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FeedTypes=t.Feed=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=d(n(893)),i=d(n(39)),s=d(n(591)),a=d(n(156)),c=d(n(8));function d(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var f=function(){function e(t,n,o,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(l(this,e),Object.assign(this,{room:t,user:n,type:o,identifier:r}),this.key=e.makeKey(n.id,o,r),this.data_provider=null,this.extras=i,this.is_local=n.id===t.user.id,this.feed_type=t.feed_types.get(o),this.is_live=!1,this.feed_type){this.feed_type=this.is_local?this.feed_type.local:this.feed_type.remote;var s=this.feed_type.data_provider;this.data_provider=new s(t)}}return o(e,[{key:"inited",value:function(){return null!==this.data_provider}},{key:"init",value:function(e){this.data_provider=e}},{key:"notify",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.is_live){var t={user:this.user,type:this.type,identifier:this.identifier,extras:this.extras};e?(console.log("send feed to =====",e,t),this.room.text_room.send_to("feed",e,t)):(console.log("send feed========",t),this.room.text_room.send("feed",t))}}},{key:"makeLive",value:function(){return this.is_live=!0,this.notify(),this}},{key:"close",value:function(){this.data_provider&&this.data_provider.close&&this.data_provider.close()}}],[{key:"makeKey",value:function(e,t,n){return e+"-"+t+"-"+n}}]),e}(),p=function(){function e(){l(this,e),this.types={}}return o(e,[{key:"register",value:function(e){var t=e.type,n=e.local,o=e.remote;if(!n.data_provider)throw"local data_provider missing ";if(!o.data_provider)throw"remote data_provider missing ";return this.types[t]={local:n,remote:o},this}},{key:"get",value:function(e){return this.types[e]}}]),e}(),v={type:"videoroom",local:{data_provider:a.default},remote:{data_provider:c.default}},g=(new p).register(v),h=function(e){function t(e){l(this,t);var n,o=u(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));o.user={},o.user.id=e.userid,o.user.name=e.username,o.room_id=e.vmrid,o.feed_types=g||new p,o.participants={},o.config={},o.on("feed_data_received",(function(t){var n=t.from,r=t.payload;n!==""+e.userid&&(console.warn("update feed",n,r,e.userid,""+e.userid===n),console.log("add remote feed"),o.addRemoteFeed(r.user,r.type,r.identifier,r.extras))}));try{n="http:"==e.protocol?"ws://"+e.host+e.rootpath+"api/ivmr/videoroom":"wss://"+e.host+e.rootpath+"api/ivmr/videoroom"}catch(e){return alert("error"),u(o)}return o.config.url=n,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),o(t,[{key:"addParticipant",value:function(e){if(!e)throw"no user";return this.participants[e.id]=this.participants[e.id]||{user:e},this.participants[e.id].feeds=this.participants[e.id].feeds||{},this.emit("participants_changed"),this.participants[e.id]}},{key:"sendParticipantMyLocalFeeds",value:function(e){this.localFeeds().forEach((function(t){t.notify(e)}))}},{key:"addRemoteFeed",value:function(e,t,n,o){var r=this.addParticipant(e),i=new f(this,r.user,t,n,o);return r.feeds[i.key]=r.feeds[i.key]||i,this.emit("participants_changed"),this.emit("onnewfeed",i),console.log("=======",this.participants),r.feeds[i.key]}},{key:"removeParticipant",value:function(e){if(this.participants[e]){var t=this.participants[e].feeds;Object.values(t).forEach((function(e){e.close()})),delete this.participants[e],this.emit("participants_changed"),this.emit("participants_deleted",e)}}},{key:"getFeed",value:function(e,t,n){if(this.participants[e]){var o=f.makeKey(e,t,n);return this.participants[e].feeds[o]}}},{key:"localFeeds",value:function(){this.addParticipant(this.user);var e=this.participants[this.user.id];return Object.values(e.feeds)}},{key:"findOrCreateLocalFeed",value:function(e,t){this.addParticipant(this.user);var n=f.makeKey(this.user.id,e,t),o=this.participants[this.user.id];o.feeds[n]=o.feeds[n]||new f(this,this.user,e,t);var r=o.feeds[n];return console.log("Local Feed",r),r}},{key:"connect",value:function(){var e=this;return console.log(this,77777),this.janusInit(this.config).then((function(){return e.text_room=new r.default(e),e.text_room.setup()}))}},{key:"janusInit",value:function(e){var t=this;return new Promise((function(n,o){s.default.init({debug:"all",callback:function(){if(s.default.isWebrtcSupported())var r=new s.default({server:e.url,token:e.token,success:function(){t.janus=r,n(r),t.emit("connected",t)},error:function(e){o()},destroyed:function(){t.emit("destoyed")}});else console.log("No WebRTC support... ")}})}))}}]),t}(i.default);t.default=h,t.Feed=f,t.FeedTypes=p},893:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();function o(e,t){t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var n="",o=0;o<e;o++){var r=Math.floor(Math.random()*t.length);n+=t.substring(r,r+1)}return n}var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.room=t,console.log(this,66666)}return n(e,[{key:"send_txt",value:function(e){var t=this,n={textroom:"message",transaction:o(12),room:this.room.room_id,text:e,ack:!1};return new Promise((function(e,o){t.plugin.data({text:JSON.stringify(n),error:o,success:e})}))}},{key:"whisper_txt",value:function(e,t){var n=this,r={textroom:"message",transaction:o(12),room:this.room.room_id,text:t,ack:!0,to:e};return new Promise((function(e,t){n.plugin.data({text:JSON.stringify(r),error:t,success:e})}))}},{key:"send_to",value:function(e,t,n){return this.whisper_txt(""+t,JSON.stringify({payload:n,type:e}))}},{key:"send",value:function(e,t){return this.send_txt(JSON.stringify({payload:t,type:e}))}},{key:"setup",value:function(){var e=this;return new Promise((function(t,n){e.room.janus.attach({plugin:"janus.plugin.textroom",opaqueId:""+e.room.user.id,success:function(t){e.plugin=t,e.plugin.send({message:{request:"setup"}})},error:function(e){n(),console.error("  -- Error attaching plugin...",e)},webrtcState:function(e){console.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},onmessage:function(t,n){console.debug(" ::: Got a message :::"),console.debug(t),void 0!==t.error&&t.error,null!=n&&e.plugin.createAnswer({jsep:n,media:{audio:!1,video:!1,data:!0},success:function(t){console.debug("Got SDP!"),console.debug(t),e.plugin.send({message:{request:"ack"},jsep:t})},error:function(e){console.error("WebRTC error:",e)}})},ondataopen:function(n){console.debug("The DataChannel is available!");var r={textroom:"join",transaction:o(12),room:e.room.room_id,username:""+e.room.user.id,display:e.room.user.name};console.log("joinign room",r),e.plugin.data({text:JSON.stringify(r),success:function(n){t(),e.room.emit("datachannelready",n)}})},ondata:function(t){var n=JSON.parse(t);console.warn("We got data from the DataChannel! ",n);var o=n.textroom;if("success"===o)n.participants&&n.participants.forEach((function(t){return e.room.addParticipant({id:t.username,name:t.display})}));else if("message"===o){var r=JSON.parse(n.text),i={from:n.from,date:n.date};for(var s in r)i[s]=r[s];i.type&&e.room.emit(i.type+"_data_received",i),e.room.emit("data_channel_recv_msg",i)}else"join"===o?(e.room.addParticipant({id:n.username,name:n.display}),e.room.sendParticipantMyLocalFeeds(n.username)):"leave"===o&&e.room.removeParticipant(n.username);e.room.emit("data_channel_recv",n)},oncleanup:function(){console.log(" ::: Got a cleanup notification :::")}})}))}}]),e}();t.default=r},156:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});var o,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.room=e,n.participants={},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"isLive",value:function(){return this.plugin&&"completed"!==this.plugin.webrtcStuff.pc.iceConnectionState&&"connected"!==this.plugin.webrtcStuff.pc.iceConnectionState}},{key:"isAudioMuted",value:function(){return this.plugin.isAudioMuted()}},{key:"muteAudio",value:function(){return this.plugin.muteAudio()}},{key:"unmuteAudio",value:function(){return this.plugin.unmuteAudio()}},{key:"changeBandwidth",value:function(e){var t=this;return new Promise((function(n,o){t.plugin.send({message:{request:"configure",bitrate:e},success:n,error:o})}))}},{key:"connect",value:function(){var e=this;return new Promise((function(t,n){e.room.janus.attach({plugin:"janus.plugin.videoroom",opaqueId:""+e.room.user.id,success:function(o){e.plugin=o;var r={request:"join",room:e.room.room_id,ptype:"publisher",display:e.room.user.name};e.plugin.send({message:r,success:t,error:n})},consentDialog:function(e){},mediaState:function(t,n){e.emit("mediaState",t,n)},webrtcState:function(t){e.emit("webrtcState",t)},onmessage:function(t,n){e.emit("onmessage",t,n);var o=t.videoroom;t.publishers&&(e.participants=t.publishers.reduce((function(e,t){return e[t.id]=t,e}),{})),o&&("joined"===o||"destroyed"===o?e.emit(o,t,n):"event"===o&&(t.error&&e.emit("error",t,n),t.publishers&&e.emit("publishers",t,n),t.leaving&&e.emit("leaving",t,n),t.unpublished&&(delete e.participants[t.unpublished],e.emit("unpublished",t,n)))),null!=n&&(e.plugin.handleRemoteJsep({jsep:n}),e.local_stream&&(e.local_stream.getAudioTracks()&&e.local_stream.getAudioTracks().length>0&&!t.audio_codec&&console.error("Our audio stream has been rejected, viewers won't hear us"),e.local_stream.getVideoTracks()&&e.local_stream.getVideoTracks().length>0&&!t.video_codec&&console.error("Our video stream has been rejected, viewers won't see us")))},onlocalstream:function(t){e.local_stream=t,e.emit("onlocalstream",t)},oncleanup:function(){e.emit("oncleanup")}})}))}},{key:"publish",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise((function(n,o){var r={audioRecv:!1,videoRecv:!1,audioSend:!0,videoSend:!0};for(var i in t)r[i]=t[i];e.plugin.createOffer({media:r,simulcast:!1,success:function(t){var i={request:"configure",audio:r.audioSend,video:r.videoSend};r.vcodec&&(i.videocodec=r.vcodec),e.plugin.send({message:i,jsep:t,success:n,error:o})},error:o})}))}}]),t}(((o=n(39))&&o.__esModule?o:{default:o}).default);t.default=i},8:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});var o,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),i=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.room=e,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"isLive",value:function(){return this.plugin&&"completed"!==this.plugin.webrtcStuff.pc.iceConnectionState&&"connected"!==this.plugin.webrtcStuff.pc.iceConnectionState}},{key:"connect",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise((function(o,r){t.room.janus.attach({plugin:"janus.plugin.videoroom",opaqueId:""+t.room.user.id,success:function(o){t.plugin=o;var i={request:"join",room:t.room.room_id,ptype:"subscriber",feed:e,display:t.room.user.name};t.plugin.videoCodec=n,t.plugin.send({message:i,error:r})},onmessage:function(e,n){console.debug("Got a message (subscriber) ",e),null!=n&&(console.debug("SUBS: Handling SDP as well..."),console.debug(n),t.plugin.createAnswer({jsep:n,media:{audioSend:!1,videoSend:!1},success:function(e){console.debug("Got SDP!"),console.debug(e);var n={request:"start",room:t.room.room_id};t.plugin.send({message:n,jsep:e,success:o})},error:r}))},webrtcState:function(e){t.emit("webrtcState",e)},onremotestream:function(e){t.remote_stream=e,t.emit("onremotestream",e)},oncleanup:function(){t.emit("oncleanup")}})}))}}]),t}(((o=n(39))&&o.__esModule?o:{default:o}).default);t.default=i}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,o),i.exports}var r={};return(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.IccRTCGetCapability=e.IccRTCPush=e.IccPlayerRTC=e.Janus=e.VideoSubscriber=e.VideoPublisher=e.TextRoom=e.AudioBridge=e.FeedTypes=e.Room=void 0;var t=o(325),n=l(t),i=l(o(805)),s=l(o(893)),a=l(o(156)),c=l(o(8)),d=l(o(591)),u=o(757);function l(e){return e&&e.__esModule?e:{default:e}}e.Room=n.default,e.FeedTypes=t.FeedTypes,e.AudioBridge=i.default,e.TextRoom=s.default,e.VideoPublisher=a.default,e.VideoSubscriber=c.default,e.Janus=d.default,e.IccPlayerRTC=u.IccPlayerRTC,e.IccRTCPush=u.IccRTCPush,e.IccRTCGetCapability=u.IccRTCGetCapability})(),r})()}));
//# sourceMappingURL=iccivmjs.min.js.map